
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>On Testing Guava Caches and Time - Data Wonder</title>
  <meta name="author" content="Mark Veronda">

  
  <meta name="description" content="TLDR: Do not forget your scale when dealing with anything related to time, whether or not you are programming. Always, always, always say &ldquo;10 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://http://datawonder.co//blog/2014/04/02/testing-guava-caches">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Data Wonder" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37078573-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Data Wonder</a></h1>
  
    <h2>Wonderings and Wanderings about Data While becoming an expert</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://datawonder.co/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">On Testing Guava Caches and Time</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-02T00:00:00-04:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>TLDR: Do not forget your scale when dealing with anything related to time, whether or not you are programming.  Always, always, always say &ldquo;10 nanoseconds&rdquo; and never just &ldquo;10&rdquo;.</p>

<p>I had a frustrating problem where I had written a few quick lines of code and found myself finagling the testing for longer than I initially expected. The lesson I learned, as provided in the TLDR, actually came from a book I was reading at the same time called <a href="http://markburgess.org/certainty.html">&ldquo;In Search of Certainty&rdquo;</a>.  The book is written by Mark Burgess, and I must say that I am shocked at how few people know about one of the most foreword thinking Computer Scientists currently around.  Equally as few people have heard of <a href="https://www.youtube.com/watch?v=4CCXs4Om5pY">CFEngine</a>, which should not need introduction as it was literally 10 years ahead of everyone else.  The few lines of code I wrote was a decorator to add caching functionality.</p>

<p>The caching part was a cakewalk because I knew from the start I would use Google <a href="https://code.google.com/p/guava-libraries/">Guava&rsquo;s</a> <a href="http://stackoverflow.com/a/4543114">amazing</a> <a href="http://gubendran.blogspot.com/2012/06/google-guava-collections-are-awesome.html">library</a> that already provides extensive, configurable and battle-tested functionality.  I would like to give a big tip of the hat I don&rsquo;t wear to the authors of the library for providing this to the world.  One neat example of how well thought out the library is when I wanted to have a <a href="http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/cache/RemovalListener.html">RemovalListener</a> (code to run upon cache eviction) only run on keys that expired due to access time and not keys that are manually evicted.  I spent a few minutes thinking of a solution but when I started to code it up and took another look at the Guava docs, sure enough, the option is right there and is a simple matter of asking the RemovalNotification object wasEvicted().  Just simply amazing.</p>

<p>The problem I was stuck on was getting the cache eviction to actually happen during testing.  Since I saw a good opportunity to apply TDD here, I actually did write my tests ahead of time.  Which was a fortunate thing because I knew I wasn&rsquo;t finished due to the two failing tests involving a cache eviction.  The second test I wrote was to ensure expiry occurs after the <em>first</em> write for any key, not any subsequent writes. That the RemovalListener was not running and cache eviction not happening at all was painfully obvious by the few missing lines of test coverage.</p>

<p>It turned out that the problem with my tests was with my usage of the <a href="http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/base/Ticker.html">Ticker</a> interface, which is quite the footnote in the documentation and discussion on testing with Guava&rsquo;s cache. The code I wrote said &lsquo;+10&rsquo; to advance time by what I presumed was 10 milliseconds.  I eventually came to the smack-of-the-forehead realization that Ticker is based on nanoseconds and therefore, when advancing its time readout, you need to advance it by TimeUnit.Milliseconds.toNanos(10) nanoseconds (AKA: 10,000,000) and not 10.  Finally, the testboard went green quickly followed by wiring up the cache and thus wrapping up my workweek in a New York minute.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Veronda</span></span>

      








  


<time datetime="2014-04-02T00:00:00-04:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/guava/'>Guava</a>, <a class='category' href='/blog/categories/java/'>Java</a>, <a class='category' href='/blog/categories/notestoself/'>NotesToSelf</a>, <a class='category' href='/blog/categories/programming/'>Programming</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://http://datawonder.co//blog/2014/04/02/testing-guava-caches/" data-via="MarkVeronda" data-counturl="http://http://datawonder.co//blog/2014/04/02/testing-guava-caches/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/01/15/data-skeptics-wsj-meetup/" title="Previous Post: Data Skeptics WSJ MeetUp">&laquo; Data Skeptics WSJ MeetUp</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/02/testing-guava-caches/">On Testing Guava Caches and Time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/15/data-skeptics-wsj-meetup/">Data Skeptics WSJ MeetUp</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/30/first-data-challenge/">First Data Challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/19/a-detour/">A Detour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/17/hello-world/">Hello World!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/markyv">@markyv</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'markyv',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Mark Veronda -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
